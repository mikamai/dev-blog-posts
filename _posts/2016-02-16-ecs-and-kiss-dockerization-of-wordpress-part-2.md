---
ID: 50
post_title: >
  ECS and KISS dockerization of WordPress
  (Part 2)
author: Gianluca
post_date: 2016-02-16 14:32:56
post_excerpt: ""
layout: post
permalink: >
  https://dev.mikamai.com/2016/02/16/ecs-and-kiss-dockerization-of-wordpress-part-2/
published: true
tumblr_mikamayhem_permalink:
  - >
    http://dev.mikamai.com/post/139422949699/ecs-and-kiss-dockerization-of-wordpress-part-2
tumblr_mikamayhem_id:
  - "139422949699"
---
<p>&lsquo;Two article ago&rsquo; I wrote about my initial experience with Docker and ECS, the container service, built on top of EC2, offered by Amazon. <a href="http://dev.mikamai.com/post/137748096409/ecs-and-kiss-dockerization-of-wordpress">Here</a> it is if you want to take a look.</p>

<p>Today I want to continue in that direction describing the configuration of containers (or better <strong>container</strong>) I choose to serve the application selected as guinea pig to try ECS. Just as a reminder, the app was an almost standard WordPress blog with a custom theme and a few plugins.</p>

<!--more-->

<p>I specified <strong>container</strong> because the app is actually served by one single container in which it is packed together with NGINX. This naive solution differs from the those offered by the Dockerfiles available online because it takes advantage mainly of two other AWS services: Amazon S3 and Amazon RDS.</p>

<p>Assuming the two products are known, the first let us store and serve the contents generated by the users (e.g. media uploaded from the WordPress dashboard), while the latter represents the actual database used by the app. AWS S3 is actually used through a WordPress plugin that I already mentioned in my previous post. Again, if you are curious, <a href="http://dev.mikamai.com/post/137748096409/ecs-and-kiss-dockerization-of-wordpress">check it out</a>.</p>

<p>Without these two services we should have handled at least two other containers, one data volume to store the uploaded media and one container to host the database engine.</p>

<p>Other containers we could have deployed are a data volume to host the WordPress core, a data volume to host the theme and a dedicated container for the Web Server. This is for sure a good example of a well organized architecture but it need additional Dockerfiles and a more complex configuration on the ECS side.</p>

<p>Considering my goal and the availability of S3 and RDS I choose a more naive approach by relying on a single, simple container. The Dockerfile I used as starting point was the one of the <a href="https://hub.docker.com/_/wordpress/">official WordPress image</a> but right now there is not so much left from that.</p>

<p>Indeed, after having online the first functioning version with Apache as Web server and the stable PHP 5.6, I started to deep dive into the possible optimizations of the container. This lead me to NGINX, PHP7 and the HHVM.</p>

<p>Long story short, right now we have a custom image built from Debian Jesse (as recommended by the <a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/">Docker docs</a>) with a custom NGINX compiled from source and the HHVM as 'PHP engine&rsquo;.</p>

<p>Here is the 'monster&rsquo; Dockerfile:</p>

<pre><code>FROM debian:jessie

ENV NGINX_VERSION 1.9.9
ENV NPS_VERSION 1.10.33.2

# Install wget and ca-certificates
RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends wget ca-certificates &amp;&amp; 
    # Set up HHVM installation
    wget -O - <a href="http://dl.hhvm.com/conf/hhvm.gpg.key">http://dl.hhvm.com/conf/hhvm.gpg.key</a> | apt-key add - &amp;&amp; 
    echo deb <a href="http://dl.hhvm.com/debian">http://dl.hhvm.com/debian</a> jessie main | tee /etc/apt/sources.list.d/hhvm.list &amp;&amp; 
    # Install all the packages we need...
    apt-get update &amp;&amp; apt-get install -y --no-install-recommends 
    build-essential zlib1g-dev libpcre3 libpcre3-dev libssl-dev hhvm unzip less &amp;&amp; 
    # Install wp-cli
    wget <a href="https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar">https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar</a> &amp;&amp; 
    chmod +x wp-cli.phar &amp;&amp; 
    mv wp-cli.phar /usr/local/bin &amp;&amp; 
    echo '#!/bin/bash' &gt;&gt; /usr/local/bin/wp &amp;&amp; 
    echo '/usr/local/bin/wp-cli.phar --allow-root $@' &gt;&gt; /usr/local/bin/wp &amp;&amp; 
    # Get PageSpeed NGINX module source
    cd &amp;&amp; 
    wget <a href="https://github.com/pagespeed/ngx_pagespeed/archive/master.zip">https://github.com/pagespeed/ngx_pagespeed/archive/master.zip</a> -O ngx_pagespeed-master.zip &amp;&amp; 
    unzip ngx_pagespeed-master.zip &amp;&amp; 
    cd ngx_pagespeed-master &amp;&amp; 
    wget <a href="https://dl.google.com/dl/page-speed/psol/%24%7BNPS_VERSION%7D.tar.gz">https://dl.google.com/dl/page-speed/psol/${NPS_VERSION}.tar.gz</a> &amp;&amp; 
    tar -xzvf ${NPS_VERSION}.tar.gz &amp;&amp; 
    # Get NGINX source
    cd &amp;&amp; 
    wget <a href="http://nginx.org/download/nginx-%24%7BNGINX_VERSION%7D.tar.gz">http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz</a> &amp;&amp; 
    tar -xvzf nginx-${NGINX_VERSION}.tar.gz &amp;&amp; 
    # Compile NGINX with all bells and whistles
    cd nginx-${NGINX_VERSION} &amp;&amp; 
    ./configure --prefix=/etc/nginx 
                --sbin-path=/usr/sbin/nginx 
                --conf-path=/etc/nginx/nginx.conf 
                --error-log-path=/var/log/nginx/error.log 
                --http-log-path=/var/log/nginx/access.log 
                --pid-path=/var/run/nginx.pid 
                --lock-path=/var/run/nginx.lock 
                --http-client-body-temp-path=/var/cache/nginx/client_temp 
                --http-proxy-temp-path=/var/cache/nginx/proxy_temp 
                --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp 
                --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp 
                --http-scgi-temp-path=/var/cache/nginx/scgi_temp 
                --user=nginx 
                --group=nginx 
                --with-http_ssl_module 
                # --with-http_realip_module 
                # --with-http_addition_module 
                # --with-http_sub_module 
                # --with-http_dav_module 
                # --with-http_flv_module 
                # --with-http_mp4_module 
                --with-http_gunzip_module 
                --with-http_gzip_static_module 
                # --with-http_random_index_module 
                --with-http_secure_link_module 
                # --with-http_stub_status_module 
                --with-http_auth_request_module 
                --with-threads 
                # --with-stream 
                # --with-stream_ssl_module 
                # --with-http_slice_module 
                # --with-mail 
                # --with-mail_ssl_module 
                --with-file-aio 
                --with-http_v2_module 
                --with-cc-opt='-g -O2 -fstack-protector-strong -Wformat -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2' 
                --with-ld-opt='-Wl,-z,relro -Wl,--as-needed' 
                --with-ipv6 
                --add-module=$HOME/ngx_pagespeed-master &amp;&amp; 
    make &amp;&amp; make install &amp;&amp; 
    # Clean up everything
    apt-get purge -y wget ca-certificates build-essential unzip &amp;&amp; 
    apt-get autoremove -y &amp;&amp; apt-get clean -y &amp;&amp; apt-get autoclean -y &amp;&amp; 
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* $HOME/ngx_pagespeed-master.zip 
       $HOME/ngx_pagespeed-master nginx-${NGINX_VERSION}.tar.gz nginx-${NGINX_VERSION}

# Add nginx user and the add it to www-data group (this need to be in a separate RUN!)
RUN useradd -r nginx &amp;&amp; usermod -a -G www-data nginx

# Configure NGINX
RUN bash -c 'mkdir -p /var/cache/nginx/{client_temp,proxy_temp,fastcgi_temp,uwsgi_temp,scgi_temp}' &amp;&amp; 
    mkdir /var/ngx_pagespeed_cache &amp;&amp; 
    mkdir /var/run/nginx-cache &amp;&amp; 
    chown -R nginx /var/cache/nginx/client_temp 
                   /var/cache/nginx/proxy_temp 
                   /var/cache/nginx/fastcgi_temp 
                   /var/cache/nginx/uwsgi_temp 
                   /var/cache/nginx/scgi_temp &amp;&amp; 
    chown -R www-data:www-data /var/ngx_pagespeed_cache /var/run/nginx-cache

# Configure HHVM
RUN /usr/share/hhvm/install_fastcgi.sh &amp;&amp; 
    /usr/bin/update-alternatives --install /usr/bin/php php /usr/bin/hhvm 60 &amp;&amp; 
    echo 'hhvm.server.expose_hphp = false' &gt;&gt; /etc/hhvm/server.ini
    # Use a UNIX socket (HHVM side)
    # sed -i '/hhvm.server.port/chhvm.server.file_socket=/var/run/hhvm/hhvm.sock' /etc/hhvm/server.ini &amp;&amp; 
    # Ser permissions on UNIX socket
    # chown -R www-data:www-data /var/run/hhvm

# Set up NGINX conf
COPY nginx.conf /etc/nginx/nginx.conf

# Set up app code
COPY . /usr/share/nginx/html

# Set permissions on app root
RUN chown -R www-data:www-data /usr/share/nginx/html

# Set up entrypoint
COPY docker-entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]

EXPOSE 80 443

CMD ["nginx", "-g", "daemon off;"]
</code></pre>

<p>I called it 'monster&rsquo; mainly because of the first big <code>RUN</code> which deals with the installation/compilation of everything needed.</p>

<p>I decided to switch from multiple separated <code>RUN</code> to one big <code>RUN</code> to minimize the number of layers of the union filesystem and to properly handle the cleanup process of the what is installed and created during the installation and compilation on NGINX. By specifing the cleanup right after the installation and compilation it is granted that nothing unneeded gets written in the layer. This allowed us to minimize the total size of the builded image. Just to 'spread the word&rsquo;, <a href="http://merrigrove.blogspot.it/2015/10/visualizing-docker-containers-and-images.html">here</a> there is a beautiful explanation on how the Docker filesystem works.</p>

<p>Among all the things handled by the 'big <code>RUN</code>&rsquo; the most interesting one is probably the <code>configure</code> step before the NGINX compilation. This step specifies all the desired NGINX modules and among them it figures also the <a href="https://developers.google.com/speed/pagespeed/module/build_ngx_pagespeed_from_source">Google PageSpeed module</a>. It grants some pretty nice advanced optimizations and I strongly recommend you to take a look at it.</p>

<p>There is actually a lot more to talk about but I think I will continue to describe the Dockerfile and the NGINX/HHVM configurations in my next article/s.</p>

<p>So stay tuned! ;P</p>

<p>Cheers!</p>