---
ID: 252
post_title: >
  A modern workflow for WordPress using
  Docker and Dokku
author: Massimo Ronca
post_date: 2014-05-12 15:49:00
post_excerpt: ""
layout: post
permalink: >
  https://dev.mikamai.com/2014/05/12/a-modern-workflow-for-wordpress-using-docker-and/
published: true
tumblr_mikamayhem_permalink:
  - >
    http://dev.mikamai.com/post/85531658709/a-modern-workflow-for-wordpress-using-docker-and
tumblr_mikamayhem_id:
  - "85531658709"
---
<img src="http://objectivesheep.com/wp-content/uploads/dokkuwp.png" alt="Dokku + WordPress" />

<p>Every developer, sooner or later, had to deal with <a href="http://wordpress.org/">WordPress</a>, given it is one of the most popular Blog/CMS platform, if not <strong>the</strong> most popular.<br />According to Wikipedia, roughly 22% of the web sites run on it, (it means one web site in five) it is widely know by users, <a href="https://wordpress.org/plugins/">it has a large community</a> (over 30 thousand contributed plugins) and it is easily supported by designers.  </p>
<p>Unfortunately WP was targeted at non-developer people, it had a great success as hosted platform, but working with it from the developer perspective, especially if we look at the workflow, looks clunky and outdated.  </p>

<!--more-->

<p>Usually it involves:</p>
<ul><li>downloading a tar ball of the latest WordPress stable version</li>
<li>rename <code>wp-config-sample.php</code> to <code>wp-config.php</code></li>
<li>if you&rsquo;re using <code>git</code> (and you should!), add the <code>wp-config.php</code> to <code>.gitignore</code></li>
<li>open a connection (possibly not FTP, but probably it will be FTP) and (slowly) upload everything on the dest server</li>
<li>create a remote<code>wp-config.php</code> with the production configuration</li>
<li>launch the installer</li>
<li>hope nobody will overwrite <code>wp-config.php</code> with the local copy</li>
</ul><p>On the other hand, modern workflows are built around some kind of version control system (usually <code>git</code>) where the deploy is managed just by pushing a branch on the public server.<br />This is called push-to-deploy and is the one used by <a href="http://heroku.com">Heroku</a>.<br />Fortunately, some smart guys created <a href="http://www.docker.io">Docker</a> and <a href="https://github.com/progrium/dokku">Dokku</a>, two projects that make possible to build you own personal-heroku-like <a href="http://en.wikipedia.org/wiki/Platform_as_a_service">PaaS</a> in a matter of minutes (If you want to try it, <a href="https://www.digitalocean.com/">Digital Ocean</a> offers cloud servers with Dokku preinstalled at a starting price of 5$/month).<br />Let&rsquo;s see how it applies to WordPress.  </p>
<blockquote>
<p>In the rest of the article I&rsquo;m going to use a few placeholders</p>
<ul><li><code>app</code> is the application name</li>
<li><code>dokku</code> is the address (or hostanme if configured) of the destination server running Docker &amp; Dokku</li>
<li><code>dokku-user</code> is the user running Dokku on the remote machine</li>
</ul></blockquote>
<p>First of all we&rsquo;re going to clone WP from <a href="http://www.github.com">github</a></p>
<pre class="editor-colors"><code class="lang-bash"><div><span class="source shell">git clone git@github.com:WordPress/WordPress.git app</span></div></code></pre>
<p>Then we create <code>wp-config.php</code>, replace the configuration parameters with environment variables, and commit it.<br />This way we won&rsquo;t have to hardcode them.</p>
<blockquote>
<p>same technique can be used to configure the <a href="http://codex.wordpress.org/Editing_wp-config.php#Security_Keys">security keys</a>, I didn&rsquo;t, to keep things short.</p>
</blockquote>
<pre class="editor-colors"><code class="lang-php"><div><span class="text html php">define('DB_NAME', getenv('WP_DB_NAME'));</span></div><div> </div><div><span class="text html php">/** MySQL database username */</span></div><div><span class="text html php">define('DB_USER', getenv('WP_DB_USER'));</span></div><div> </div><div><span class="text html php">/** MySQL database password */</span></div><div><span class="text html php">define('DB_PASSWORD', getenv('WP_DB_PASS'));</span></div><div> </div><div><span class="text html php">/** MySQL hostname */</span></div><div><span class="text html php">define('DB_HOST', getenv('WP_DB_HOST'));</span></div></code></pre>
<pre class="editor-colors"><code class="lang-bash"><div><span class="source shell">git add wp-config.php</span></div><div><span class="source shell">git commit -m <span class="string quoted single shell"><span class="punctuation definition string begin shell">'</span>added WordPress configuration<span class="punctuation definition string end shell">'</span></span></span></div></code></pre>
<p>If you use <a href="http://apache.org/">Apache</a>, you can set the values with <a href="http://httpd.apache.org/docs/2.2/mod/mod_env.html"><code>SetEnv</code></a>, if you&rsquo;re running <a href="http://nginx.org/">Nginx</a> and <a href="http://php-fpm.org/">phpf-pm</a>, you can use the <a href="http://www.php.net/manual/it/install.fpm.configuration.php#example-73"><code>ENV</code> section</a> of your application pool.<br />You don&rsquo;t need any of that when deploying through Dokku.  </p>
<p>For our first deploy, we need to add a new <code>remote</code> pointing at the Dokku  server</p>
<pre class="editor-colors"><code class="lang-bash"><div><span class="source shell">git remote add dokku dokku-user@dokku:app</span></div></code></pre>
<p>and push the code</p>
<pre class="editor-colors"><code class="lang-bash"><div><span class="source shell">git push dokku master</span></div></code></pre>
<p>You will see something like this</p>
<pre class="editor-colors"><code class="lang-bash"><div><span class="source shell">Counting objects: 163187, <span class="keyword control shell">done</span>.</span></div><div><span class="source shell">Delta compression using up to 4 threads.</span></div><div><span class="source shell">Compressing objects: 100% <span class="meta scope subshell shell"><span class="punctuation definition subshell shell">(</span>33726/33726<span class="punctuation definition subshell shell">)</span></span>, <span class="keyword control shell">done</span>.</span></div><div><span class="source shell">Writing objects: 100% <span class="meta scope subshell shell"><span class="punctuation definition subshell shell">(</span>163187/163187<span class="punctuation definition subshell shell">)</span></span>, 84.87 MiB <span class="keyword operator pipe shell">|</span> 4.95 MiB/s, <span class="keyword control shell">done</span>.</span></div><div><span class="source shell">Total 163187 <span class="meta scope subshell shell"><span class="punctuation definition subshell shell">(</span>delta 128758<span class="punctuation definition subshell shell">)</span></span>, reused 163156 <span class="meta scope subshell shell"><span class="punctuation definition subshell shell">(</span>delta 128730<span class="punctuation definition subshell shell">)</span></span></span></div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> Building app ...</span></div><div><span class="source shell">       PHP <span class="meta scope subshell shell"><span class="punctuation definition subshell shell">(</span>classic<span class="punctuation definition subshell shell">)</span></span> app detected</span></div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> Bundling NGINX 1.4.3</span></div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> Bundling PHP 5.5.5</span></div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> Bundling extensions</span></div><div><span class="source shell">       phpredis</span></div><div><span class="source shell">       mongo</span></div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> Setting up default configuration</span></div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> Vendoring binaries into slug</span></div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> Discovering process types</span></div><div><span class="source shell">       Default process types <span class="meta scope for-in-loop shell"><span class="keyword control shell">for</span> <span class="variable other loop shell">PHP</span> <span class="meta scope subshell shell"><span class="punctuation definition subshell shell">(</span>classic<span class="punctuation definition subshell shell">)</span></span> -<span class="keyword operator redirect shell">&gt;</span> web</span></span></div><div><span class="source shell"><span class="meta scope for-in-loop shell">-----<span class="keyword operator redirect shell">&gt;</span> Releasing app ...</span></span></div><div><span class="source shell"><span class="meta scope for-in-loop shell">-----<span class="keyword operator redirect shell">&gt;</span> Deploying app ...</span></span></div><div><span class="source shell"><span class="meta scope for-in-loop shell">-----<span class="keyword operator redirect shell">&gt;</span> Cleaning up ...</span></span></div><div><span class="source shell"><span class="meta scope for-in-loop shell">=====<span class="keyword operator redirect shell">&gt;</span> Application deployed:</span></span></div><div><span class="source shell"><span class="meta scope for-in-loop shell">       http://app_url</span></span></div><div> </div><div><span class="source shell"><span class="meta scope for-in-loop shell">To dokku@dokku:app</span></span></div><div><span class="source shell"><span class="meta scope for-in-loop shell"> <span class="keyword operator glob shell">*</span> [new branch]      master -<span class="keyword operator redirect shell">&gt;</span> master</span></span></div></code></pre>
<p>As you can see, everything is already bundled with the PHP buildpack.<br />Dokku has detected the PHP app and instructed Docker to create an isolated container that could run the application.  </p>
<p>You can now open up a browser and point to app_url (it can have two formats: <a href="http://ip_adress:port">http://ip_adress:port</a> or <a href="http://app.defaultdomain">http://app.defaultdomain</a>. Either way, it should launch your app).  </p>
<p>Our wp-config is empty right now, the server will reply with  </p>
<p><img src="http://i.imgur.com/JzhJclD.png" alt="WP Error" /></p>
<p>That&rsquo;s good news, it means it is actually responding to our request.  </p>
<p> To finish our setup we need a couple more things:</p>
<ul><li>create a database</li>
<li>configure the app environment with the credentials  </li>
</ul><p>To create a db in our app container, we&rsquo;ll use the <a href="https://github.com/Kloadut/dokku-md-plugin">MariaDB plugin for Dokku</a>.<br />There&rsquo;s also a <a href="https://github.com/hughfletcher/dokku-mysql-plugin">MySQL plugin</a>, but it has some annoying bug and since MySQL and MariaDB
are virtually identical, we&rsquo;ll stick with the last one.<br />Installing a plugin for Dokku is as easy as running</p>
<pre class="editor-colors"><code class="lang-bash"><div><span class="source shell"><span class="support function builtin shell">cd</span> /var/lib/dokku/plugins</span></div><div><span class="source shell">git clone <a href="https://github.com/Kloadut/dokku-md-plugin">https://github.com/Kloadut/dokku-md-plugin</a> mariadb</span></div><div><span class="source shell">dokku plugins-install</span></div></code></pre>
<p>Some of them don&rsquo;t require the final <code>plugins-install</code> step, but it won&rsquo;t hurt if you run it anyway.  </p>
<blockquote>
<p>Tip: you can run dokku commands on your local machine and execute them on the remote one with:
<code>ssh dokku-host dokku-command</code> (i.e. <code>ssh dokku help</code>)</p>
</blockquote>
<p>We can now create the database</p>
<pre class="editor-colors"><code class="lang-bash"><div> </div><div><span class="source shell"> ssh dokku mariadb:create app</span></div><div> </div><div><span class="source shell"> -----<span class="keyword operator redirect shell">&gt;</span> Creating /home/dokku/app/ENV</span></div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> Setting config vars and restarting app</span></div><div><span class="source shell">DATABASE_URL: mysql2://root:VQpzDZRrEUAkUuAI@172.17.42.1:49170/db</span></div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> Releasing app ...</span></div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> Release <span class="support function builtin shell">complete</span><span class="keyword operator pipe shell">!</span></span></div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> Deploying app ...</span></div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> Deploy <span class="support function builtin shell">complete</span><span class="keyword operator pipe shell">!</span></span></div><div> </div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> app linked to mariadb/app database</span></div><div> </div><div><span class="source shell">-----<span class="keyword operator redirect shell">&gt;</span> MariaDB container created: mariadb/app</span></div><div> </div><div><span class="source shell">       Host: 172.17.42.1</span></div><div><span class="source shell">       Port: 49170</span></div><div><span class="source shell">       User: <span class="string quoted single shell"><span class="punctuation definition string begin shell">'</span>root<span class="punctuation definition string end shell">'</span></span></span></div><div><span class="source shell">       Password: <span class="string quoted single shell"><span class="punctuation definition string begin shell">'</span>VQpzDZRrEUAkUuAI<span class="punctuation definition string end shell">'</span></span></span></div><div><span class="source shell">       Database: <span class="string quoted single shell"><span class="punctuation definition string begin shell">'</span>db<span class="punctuation definition string end shell">'</span></span></span></div></code></pre>
<p> and set set the Environment variables</p>
<pre class="editor-colors"><code class="lang-bash"><div><span class="source shell"><span class="punctuation whitespace comment leading shell"> </span><span class="comment line number-sign shell"><span class="punctuation definition comment shell">#</span> the format is dokku config:set app key=value key=value</span></span></div><div><span class="source shell"><span class="punctuation whitespace comment leading shell"> </span><span class="comment line number-sign shell"><span class="punctuation definition comment shell">#</span> I splitted up the command on different lines for clarity</span></span></div><div><span class="source shell"> ssh dokku config:<span class="support function builtin shell">set</span> app WP_DB_HOST=<span class="string quoted single shell"><span class="punctuation definition string begin shell">'</span>172.17.42.1:49170<span class="punctuation definition string end shell">'</span></span></span></div><div><span class="source shell"> ssh dokku config:<span class="support function builtin shell">set</span> app WP_DB_NAME=<span class="string quoted single shell"><span class="punctuation definition string begin shell">'</span>db<span class="punctuation definition string end shell">'</span></span></span></div><div><span class="source shell"> ssh dokku config:<span class="support function builtin shell">set</span> app WP_DB_USER=<span class="string quoted single shell"><span class="punctuation definition string begin shell">'</span>root<span class="punctuation definition string end shell">'</span></span></span></div><div><span class="source shell"> ssh dokku config:<span class="support function builtin shell">set</span> app WP_DB_PASS=<span class="string quoted single shell"><span class="punctuation definition string begin shell">'</span>VQpzDZRrEUAkUuAI<span class="punctuation definition string end shell">'</span></span></span></div></code></pre>
<p>If everything went right, you should now see the standard WordPress install.<br />Choose a title, create an admin user and you&rsquo;re ready to go.<br />You can work on your local copy, add plugins, work on your theme, and when you&rsquo;re happy with it, you push all the changes and the app is automatically deployed and configured.  </p>
<p>We just scratched the surface of what is possible with Docker &amp; Dokku.<br />In a next article we&rsquo;ll see how to create a Dokku plugin to automate the entire process.  </p>